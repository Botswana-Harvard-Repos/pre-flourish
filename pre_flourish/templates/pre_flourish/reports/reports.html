{% extends 'pre_flourish/base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load export_url from django_tables2 %}
{% load pre_flourish_dashboard_extras %}



{% block extra-scripts %}
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>

    <script type="text/javascript">
        window.onload = function () {
            const genderData = {{ gender_data|safe }};
            const data = {{ data|safe }};

            const genderLabels = genderData?.map(d => d.gender);
            const genderCounts = genderData?.map(d => d.count);

            // Initialize the BMI group counters
            const bmiGroups = {
                '<15': 0,
                '15-17.9': 0,
                '>=18': 0
            };

            // Iterate through the data and count the number of participants in each BMI group
            data?.forEach(d => {
                const heuBmi = parseFloat(d.fields.heu_prt_bmi);
                const huuBmi = parseFloat(d.fields.huu_prt_bmi);
                const bmis = [heuBmi, huuBmi];

                bmis.forEach(bmi => {
                    if (bmi < 15) {
                        bmiGroups['<15']++;
                    } else if (bmi >= 15 && bmi < 18) {
                        bmiGroups['15-17.9']++;
                    } else if (bmi >= 18) {
                        bmiGroups['>=18']++;
                    }
                });
            });

            // Separate HUU and HEU data
            const huuData = data.filter(d => d.fields.huu_prt_age && d.fields.huu_prt_bmi);
            const heuData = data.filter(d => d.fields.heu_prt_age && d.fields.heu_prt_bmi);

            // Prepare the data for HUU and HEU charts
            const huuAges = huuData.map(d => d.fields.huu_prt_age);
            const huuBmis = huuData.map(d => parseFloat(d.fields.huu_prt_bmi));
            const heuAges = heuData.map(d => d.fields.heu_prt_age);
            const heuBmis = heuData.map(d => parseFloat(d.fields.heu_prt_bmi));

            // Create the HUU Age vs. BMI chart
            const huuCtx = document.getElementById('huuAgeBmiChart').getContext('2d');
            const huuAgeBmiChart = new Chart(huuCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'HUU Age vs. BMI',
                            data: huuData.map((d, i) => ({x: huuAges[i], y: huuBmis[i]})),
                            backgroundColor: 'rgba(75, 192, 192, 0.4)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'BMI'
                            }
                        }
                    }
                }
            });

            // Create the HEU Age vs. BMI chart
            const heuCtx = document.getElementById('heuAgeBmiChart').getContext('2d');
            const heuAgeBmiChart = new Chart(heuCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'HEU Age vs. BMI',
                            data: heuData.map((d, i) => ({x: heuAges[i], y: heuBmis[i]})),
                            backgroundColor: 'rgba(255, 99, 132, 0.4)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'BMI'
                            }
                        }
                    }
                }
            });


            // Create the chart with the BMI group data
            const ctx = document.getElementById('matchedBmiGroupChart').getContext('2d');
            const bmiGroupChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(bmiGroups),
                    datasets: [
                        {
                            label: 'BMI Groups',
                            data: Object.values(bmiGroups),
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(255, 99, 132, 0.2)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });


            const genderCtx = document.getElementById('genderChart').getContext('2d');
            const genderChart = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: genderLabels,
                    datasets: [
                        {
                            label: 'Gender Distribution',
                            data: genderCounts,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                            ],
                            borderWidth: 1
                        }
                    ]
                },
            });
        }
    </script>
{% endblock extra-scripts %}

{% block extra-styles %}
    <style>
        .container {
            margin-top: 20px;
            padding-bottom: 5rem;
        }

        .panel-body {
            height: 300px;
        }

        .table {
            height: 50vh;
        }

        .key-body {
            height: 10.5rem;
        }

        .table td {
            overflow-x: auto;
            white-space: nowrap;
            max-height: 200px;
            max-width: 300px;
        }

        .panel-heading-nav {
            border-bottom: 0;
            padding: 10px 0 0;
        }

        .panel-heading-nav .nav {
            padding-left: 10px;
            padding-right: 10px;
        }

        .panel.panel-default {
            overflow-x: auto;
        }
    </style>
{% endblock extra-styles %}

{% block main %}
    <h1>Enrolment Summary</h1>
    <div id="main">
        <div class="container">
            <div class="row">
                {% heu_matrix_pool bmi_age_data %}
                {% huu_matrix_pool huu_report %}
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="panel panel-default">
                    <div class="panel-heading panel-heading-nav">
                        <ul class="nav nav-tabs">
                            <li role="presentation" class="active">
                                <a href="#one" aria-controls="one" role="tab"
                                   data-toggle="tab">HEU Matrix Pool</a>
                            </li>
                            <li role="presentation">
                                <a href="#two" aria-controls="two" role="tab"
                                   data-toggle="tab">HUU Matrix Pool</a>
                            </li>
                        </ul>
                    </div>
                    <div class="panel-body">
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane fade in active" id="one">
                                {% render_table table %}
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="two">
                                {% render_table table2 %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}
